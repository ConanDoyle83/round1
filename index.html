<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ã€ã„ã¤ã VS ã‚†ãšãã€‘ã‚¹ãƒãƒƒãƒãƒ£ 1v1 å‹æ•—ãƒˆãƒ©ãƒƒã‚«ãƒ¼ï¼ˆã‚¹ãƒãƒ›æœ€é©ï¼‰</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0B1020;
      --surface: rgba(255,255,255,.06);
      --surface2: rgba(255,255,255,.04);
      --text:#EAF0FF;
      --muted:#9AA6C3;
      --border: rgba(255,255,255,.10);
      --shadow: 0 12px 30px rgba(0,0,0,.45);
      --radius: 18px;

      /* æ¯”ç‡ã‚«ãƒ©ãƒ¼ï¼ˆæŒ‡å®šï¼‰ */
      --itsuki: #EF4444; /* èµ¤ */
      --yuzuki: #3B82F6; /* é’ */

      /* select ã¯è¦æœ›ï¼šç™½èƒŒæ™¯ï¼‹é»’æ–‡å­— */
      --select-bg:#FFFFFF;
      --select-text:#000000;
      --select-border: rgba(0,0,0,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 10% 0%, rgba(59,130,246,.20), transparent 60%),
        radial-gradient(1100px 650px at 95% 15%, rgba(239,68,68,.18), transparent 60%),
        linear-gradient(180deg, #070A14 0%, #0B1020 55%, #0A0F1E 100%);
      line-height: 1.6;
    }

    .wrap{
      max-width: 720px;
      margin: 0 auto;
      padding: 14px 12px 96px;
    }

    header{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom: 12px;
    }
    h1{
      margin:0;
      font-size: clamp(22px, 6vw, 30px);
      letter-spacing:-0.02em;
      line-height:1.12;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size:13px;
    }
    .chipline{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 13px;
      backdrop-filter: blur(8px);
    }
    .chip strong{ color: var(--text); font-weight: 800; }

    .card{
      background: linear-gradient(180deg, var(--surface), var(--surface2));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      margin-top: 12px;
      backdrop-filter: blur(10px);
    }
    .card .hd{
      padding: 12px 12px 10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .card .hd h2{
      margin:0;
      font-size: 15px;
      letter-spacing:-0.01em;
    }
    .card .hd .hint{
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .card .bd{ padding: 12px; }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight: 800;
      font-size: 14px;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(239,68,68,.24), rgba(59,130,246,.18));
      border-color: rgba(255,255,255,.14);
    }
    .btn.ghost{ color: var(--muted); background: rgba(255,255,255,.03); }
    .mini{ padding: 9px 10px; font-size: 13px; border-radius: 12px; }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi{
      padding: 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .kpi .label{ color: var(--muted); font-size: 12px; }
    .kpi .value{
      margin-top: 4px;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: -0.02em;
    }
    .mono{ font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1; }

    .split{
      display:flex;
      gap:8px;
      margin-top: 8px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      display:inline-block;
      border:1px solid rgba(255,255,255,.12);
    }
    .dot.red{ background: var(--itsuki); }
    .dot.blue{ background: var(--yuzuki); }

    .glist{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .gitem{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .gitem-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .gname{ font-weight: 900; font-size: 15px; }
    .nums{
      display:flex;
      gap:10px;
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }
    .nums b{ color: var(--text); }

    .rate{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .bar{
      height: 10px;
      flex:1;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(239,68,68,.95), rgba(59,130,246,.55));
      border-radius: 999px;
      transition: width .2s ease;
    }
    .pct{
      width: 56px;
      text-align:right;
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
    }
    .gactions{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }
    .btn.itsuki{
      background: rgba(239,68,68,.16);
      border-color: rgba(239,68,68,.45);
    }
    .btn.yuzuki{
      background: rgba(59,130,246,.16);
      border-color: rgba(59,130,246,.45);
    }

    canvas{
      width:100%;
      height: 210px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .legend{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
      align-items:center;
    }

    .log-controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom: 10px;
    }
    .log{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .log-item{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 10px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .log-item .left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .log-item .meta{
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .log-item .main{
      font-weight: 900;
      font-size: 14px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      height: fit-content;
    }
    .tag strong{ color: var(--text); }

    .note{ margin-top: 10px; color: var(--muted); font-size: 12px; }
    .help{ color: var(--muted); font-size: 12px; margin-top: -4px; }

    select.select-black{
      width:100%;
      border-radius: 12px;
      border: 1px solid var(--select-border);
      background: var(--select-bg);
      color: var(--select-text);
      padding: 10px 12px;
      outline:none;
      font-size: 14px;
      font-weight: 800;
    }
    select.select-black option{
      color: var(--select-text);
      background: var(--select-bg);
    }

    textarea, .input{
      width:100%;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      outline:none;
      font-size: 14px;
    }
    textarea{ min-height: 86px; resize: vertical; }

    /* Bottom barï¼ˆï¼‹è¨˜éŒ²ï¼‹çµæœç™ºè¡¨ï¼‰ */
    .bottom-bar{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 12px 12px;
      background: linear-gradient(180deg, rgba(7,10,20,0), rgba(7,10,20,.92) 30%, rgba(7,10,20,.98));
      backdrop-filter: blur(12px);
      z-index: 40;
      border-top: 1px solid rgba(255,255,255,.08);
    }
    .bottom-inner{
      max-width: 720px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .bottom-inner .btn{
      padding: 12px 12px;
      border-radius: 16px;
      font-size: 15px;
    }

    /* Modal */
    .modal-backdrop{
      position: fixed;
      inset:0;
      display:none;
      place-items:end center;
      padding: 12px;
      background: rgba(0,0,0,.62);
      z-index: 50;
    }
    .modal{
      width: min(720px, 100%);
      background: rgba(18,24,38,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(14px);
    }
    .modal .hd{
      padding: 12px 12px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modal .hd h3{ margin:0; font-size: 15px; }
    .modal .bd{ padding: 12px; }
    .modal .ft{
      padding: 12px;
      display:flex;
      gap:10px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .modal .ft .btn{ flex:1; }

    .form{ display:grid; gap: 10px; }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 420px){
      .row2{ grid-template-columns: 1fr; }
      .bottom-inner{ grid-template-columns: 1fr; }
    }

    /* ===== çµæœç™ºè¡¨ UI ===== */
    .result-hero{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 12px;
      display:grid;
      gap:8px;
    }
    .result-title{
      font-weight: 900;
      font-size: 16px;
      letter-spacing: -0.01em;
    }
    .result-line{
      color: var(--muted);
      font-size: 13px;
    }
    .result-score{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 4px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      font-size: 13px;
      color: var(--muted);
    }
    .pill strong{ color: var(--text); }
    .pill .sw{ width:10px;height:10px;border-radius:999px; display:inline-block; border:1px solid rgba(255,255,255,.12); }
    .sw.red{ background: var(--itsuki); }
    .sw.blue{ background: var(--yuzuki); }

    .result-table{
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      overflow:hidden;
    }
    .result-row{
      display:grid;
      grid-template-columns: 1.2fr .8fr .8fr .8fr;
      gap:8px;
      padding: 10px 12px;
      background: rgba(255,255,255,.03);
      border-top: 1px solid rgba(255,255,255,.08);
      align-items:center;
      font-size: 13px;
    }
    .result-row.head{
      background: rgba(255,255,255,.05);
      font-weight: 800;
      color: var(--muted);
      border-top:none;
    }
    .right{ text-align:right; }
    .game-name{ font-weight: 900; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>ã€ã„ã¤ã VS ã‚†ãšãã€‘ã‚¹ãƒãƒƒãƒãƒ£ 1v1 å‹æ•—ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>
      <p class="sub">å‹ç‡ã¯ã€Œã„ã¤ãï¼‹ã‚†ãšãï¼100%ã€ã§å›ºå®šã€‚æ¯”ç‡ã‚‚èµ¤ï¼ˆã„ã¤ãï¼‰Ã—é’ï¼ˆã‚†ãšãï¼‰ã§è¦‹ãˆã‚‹åŒ–ã€‚</p>
      <div class="chipline">
        <span class="chip">åˆè¨ˆè©¦åˆæ•°ï¼š<strong id="totalMatches">0</strong></span>
        <span class="chip">å¯¾æˆ¦ï¼š<strong id="matchupLabel">ã„ã¤ã VS ã‚†ãšã</strong></span>
      </div>
    </header>

    <section class="card">
      <div class="hd">
        <h2>ã‚µãƒãƒªãƒ¼</h2>
        <div class="hint">å…¨ç«¶æŠ€åˆç®—</div>
      </div>
      <div class="bd">
        <div class="kpis">
          <div class="kpi">
            <div class="label">ã„ã¤ãã®å‹ã¡</div>
            <div class="value mono" id="sumWins">0</div>
          </div>
          <div class="kpi">
            <div class="label">ã‚†ãšãã®å‹ã¡</div>
            <div class="value mono" id="sumLosses">0</div>
          </div>
          <div class="kpi">
            <div class="label">ã„ã¤ãå‹ç‡</div>
            <div class="value mono" id="rateItsuki">0%</div>
          </div>
          <div class="kpi">
            <div class="label">ã‚†ãšãå‹ç‡</div>
            <div class="value mono" id="rateYuzuki">0%</div>
          </div>
        </div>

        <div class="split">
          <span class="badge"><i class="dot red"></i>ã„ã¤ã</span>
          <span class="badge"><i class="dot blue"></i>ã‚†ãšã</span>
          <span class="badge mono" id="ratioText">0 : 0</span>
        </div>

        <p class="note">â€»å‹ç‡ã¯åˆè¨ˆ100%ã«ãªã‚‹ã‚ˆã†ã«è¨ˆç®—ï¼ˆè©¦åˆ0ã®ã¨ãã¯ä¸¡æ–¹0%ï¼‰ã€‚</p>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        <h2>ç«¶æŠ€ã”ã¨ã®å‹æ•—</h2>
        <div class="hint">è¦ªæŒ‡ã§æŠ¼ã›ã‚‹</div>
      </div>
      <div class="bd">
        <div class="glist" id="glist"></div>
        <p class="note">ã€Œå‹ã¡/è² ã‘ã€ãƒœã‚¿ãƒ³ã¯å³åŠ ç®—ï¼†ãƒ­ã‚°ã‚‚è‡ªå‹•ã§æ®‹ã‚‹ï¼ˆãƒ¡ãƒ¢ç„¡ã—ï¼‰ã€‚</p>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        <h2>å‹ã¡è² ã‘ã®æ¯”ç‡</h2>
        <div class="hint">èµ¤=ã„ã¤ã / é’=ã‚†ãšã</div>
      </div>
      <div class="bd">
        <canvas id="donut" width="800" height="420" aria-label="å‹ã¡è² ã‘æ¯”ç‡"></canvas>
        <div class="legend">
          <span><i class="dot red"></i>ã„ã¤ã</span>
          <span><i class="dot blue"></i>ã‚†ãšã</span>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        <h2>æœ€è¿‘ã®è©¦åˆãƒ­ã‚°</h2>
        <div class="hint">ãƒ¡ãƒ¢ä»˜ã</div>
      </div>
      <div class="bd">
        <div class="log-controls">
          <select id="filterGame" class="select-black" style="flex:1; min-width: 180px;">
            <option value="all">ã™ã¹ã¦è¡¨ç¤º</option>
          </select>
          <button class="btn mini ghost" id="clearLog">ãƒ­ã‚°ã ã‘æ¶ˆã™</button>
        </div>
        <div class="log" id="log"></div>
        <p class="note">ãƒ­ã‚°ã¯æœ€å¤§100ä»¶ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã€‚</p>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        <h2>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
        <div class="hint">è¦æ³¨æ„</div>
      </div>
      <div class="bd">
        <button class="btn" id="resetAll" style="width:100%;">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå‹æ•—ãƒ»ãƒ­ã‚°å…¨éƒ¨å‰Šé™¤ï¼‰</button>
        <p class="note">æ¶ˆã—ãŸã‚‰æˆ»ã›ã‚“ã€‚</p>
      </div>
    </section>
  </div>

  <!-- Bottom barï¼ˆï¼‹è¨˜éŒ²ï¼‹çµæœç™ºè¡¨ï¼‰ -->
  <div class="bottom-bar">
    <div class="bottom-inner">
      <button class="btn primary" id="openAdd">ï¼‹ 1è©¦åˆã‚’è¨˜éŒ²ï¼ˆãƒ¡ãƒ¢ä»˜ãï¼‰</button>
      <button class="btn" id="openResult">ğŸ çµæœç™ºè¡¨</button>
    </div>
  </div>

  <!-- Modalï¼š1è©¦åˆã®è©³ç´°è¨˜éŒ² -->
  <div class="modal-backdrop" id="backdrop" role="dialog" aria-modal="true" aria-label="è©¦åˆã‚’è¨˜éŒ²">
    <div class="modal">
      <div class="hd">
        <h3>1è©¦åˆã‚’è¨˜éŒ²ï¼ˆã„ã¤ã vs ã‚†ãšãï¼‰</h3>
        <button class="btn mini ghost" id="closeAdd">é–‰ã˜ã‚‹</button>
      </div>
      <div class="bd">
        <div class="form">
          <div class="row2">
            <div>
              <label class="help">ç«¶æŠ€ï¼ˆç™½èƒŒæ™¯ãƒ»é»’æ–‡å­—ï¼‰</label>
              <select id="mGame" class="select-black"></select>
            </div>
            <div>
              <label class="help">å‹ã£ãŸã®ã¯ã©ã£ã¡ï¼Ÿ</label>
              <select id="mWinner" class="select-black">
                <option value="itsuki">ã„ã¤ã</option>
                <option value="yuzuki">ã‚†ãšã</option>
              </select>
            </div>
          </div>

          <div>
            <label class="help">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="mNote" placeholder="ä¾‹ï¼šå“çƒ 11-9ã€æœ€å¾Œã®ã‚µãƒ¼ãƒ–è‰¯ã‹ã£ãŸ ãªã©"></textarea>
          </div>

          <div class="help">ä¿å­˜ã™ã‚‹ã¨ï¼šç«¶æŠ€åˆ¥ã®å‹æ•—ï¼‹ã‚µãƒãƒªãƒ¼ï¼‹æ¯”ç‡ã‚°ãƒ©ãƒ•ï¼‹ãƒ­ã‚°ãŒå…¨éƒ¨æ›´æ–°ã•ã‚Œã¾ã™ã€‚</div>
        </div>
      </div>
      <div class="ft">
        <button class="btn" id="cancelAdd">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn primary" id="saveMatch">ä¿å­˜ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Modalï¼šçµæœç™ºè¡¨ï¼ˆé›†è¨ˆã¾ã¨ã‚ï¼‹ç…½ã‚Šï¼‰ -->
  <div class="modal-backdrop" id="resultBackdrop" role="dialog" aria-modal="true" aria-label="çµæœç™ºè¡¨">
    <div class="modal">
      <div class="hd">
        <h3>ğŸ çµæœç™ºè¡¨</h3>
        <button class="btn mini ghost" id="closeResult">é–‰ã˜ã‚‹</button>
      </div>
      <div class="bd">
        <!-- ã“ã“ã‚’JSã§åŸ‹ã‚ã‚‹ -->
        <div class="result-hero">
          <div class="result-title" id="resultTitle">â€”</div>
          <div class="result-line" id="resultLine">â€”</div>

          <div class="result-score">
            <span class="pill"><span class="sw red"></span>ã„ã¤ã <strong class="mono" id="rItsukiWins">0</strong></span>
            <span class="pill"><span class="sw blue"></span>ã‚†ãšã <strong class="mono" id="rYuzukiWins">0</strong></span>
            <span class="pill mono" id="rRates">0% / 0%</span>
          </div>
        </div>

        <div class="result-table" id="resultTable">
          <div class="result-row head">
            <div>ç«¶æŠ€</div>
            <div class="right">ã„ã¤ã</div>
            <div class="right">ã‚†ãšã</div>
            <div class="right">è©¦åˆæ•°</div>
          </div>
          <!-- rows injected -->
        </div>

        <p class="note">â€»ç…½ã‚Šã¯å…„å¼Ÿãƒãƒªã®ã‚¸ãƒ§ãƒ¼ã‚¯ä»•æ§˜ã€‚ã‚„ã°ã„æ–¹å‘ã«ã—ãŸã‘ã‚Œã°æ–‡è¨€ã ã‘å·®ã—æ›¿ãˆã‚Œã°OKã€‚</p>
      </div>
      <div class="ft">
        <button class="btn" id="resultCopy">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="btn primary" id="resultReset">ã“ã®ã¾ã¾å…¨ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </div>

  <script>
    const PLAYER_A = "ã„ã¤ã";
    const PLAYER_B = "ã‚†ãšã";

    const GAMES = [
      "ãƒã‚¹ã‚±","ã‚µãƒƒã‚«ãƒ¼","ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°","å“çƒ","ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³","ãƒ†ãƒ‹ã‚¹","ãƒãƒ¬ãƒ¼","ãƒ€ãƒ¼ãƒ„",
      "ã‚¢ãƒ¼ãƒã‚§ãƒªãƒ¼","ãƒ“ãƒªãƒ¤ãƒ¼ãƒ‰","ã‚¨ã‚¢ãƒ›ãƒƒã‚±ãƒ¼","ãƒãƒªã‚ªã‚«ãƒ¼ãƒˆ","å¤ªé¼“ã®é”äºº","ãƒ¯ãƒ‹ãƒ¯ãƒ‹ãƒ‘ãƒ‹ãƒƒã‚¯","ã‚¬ãƒ³ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°",
      "ãã®ä»–"
    ];

    const STORAGE_KEY = "spotcha_1v1_tracker_mobile_v4_with_result";

    function defaultState(){
      const stats = {};
      for(const g of GAMES) stats[g] = { win:0, loss:0 };
      return { stats, log: [] };
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return defaultState();
        const parsed = JSON.parse(raw);

        const st = defaultState();
        if(parsed?.stats){
          for(const g of Object.keys(st.stats)){
            const s = parsed.stats[g];
            if(s && Number.isFinite(s.win) && Number.isFinite(s.loss)){
              st.stats[g].win = Math.max(0, s.win|0);
              st.stats[g].loss = Math.max(0, s.loss|0);
            }
          }
        }
        if(Array.isArray(parsed?.log)){
          st.log = parsed.log.slice(0,100).filter(x => x && x.game && (x.winner==="itsuki"||x.winner==="yuzuki"));
        }
        return st;
      }catch{
        return defaultState();
      }
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    const $ = (sel, el=document) => el.querySelector(sel);
    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

    function totalItsuki(){ return Object.values(state.stats).reduce((a,s)=>a+s.win,0); }
    function totalYuzuki(){ return Object.values(state.stats).reduce((a,s)=>a+s.loss,0); }
    function totalMatches(){ return totalItsuki() + totalYuzuki(); }

    function fmtPct(x){
      if(!Number.isFinite(x)) return "0%";
      const v = Math.round(x*10)/10;
      return (v%1===0 ? v.toFixed(0) : v.toFixed(1)) + "%";
    }

    function niceDate(ts){
      const d=new Date(ts);
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const day=String(d.getDate()).padStart(2,"0");
      const hh=String(d.getHours()).padStart(2,"0");
      const mm=String(d.getMinutes()).padStart(2,"0");
      return `${y}/${m}/${day} ${hh}:${mm}`;
    }

    function escapeHtml(str){
      return str
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function calcRates(){
      const w = totalItsuki();
      const l = totalYuzuki();
      const t = w + l;
      if(t === 0) return { itsuki: 0, yuzuki: 0, w, l, t };
      const itsukiRate = (w / t) * 100;
      const yuzukiRate = 100 - itsukiRate;
      return { itsuki: itsukiRate, yuzuki: yuzukiRate, w, l, t };
    }

    function renderHeader(){
      $("#totalMatches").textContent = totalMatches();
      $("#matchupLabel").textContent = `${PLAYER_A} VS ${PLAYER_B}`;
    }

    function renderSummary(){
      const {itsuki, yuzuki, w, l} = calcRates();
      $("#sumWins").textContent = w;
      $("#sumLosses").textContent = l;
      $("#rateItsuki").textContent = fmtPct(itsuki);
      $("#rateYuzuki").textContent = fmtPct(yuzuki);
      $("#ratioText").textContent = `${w} : ${l}`;
    }

    function renderGameList(){
      const glist = $("#glist");
      glist.innerHTML = "";

      for(const game of GAMES){
        const s = state.stats[game];
        const w = s.win, l = s.loss;
        const t = w + l;
        const itsukiRate = (t===0) ? 0 : (w / t) * 100;

        const div = document.createElement("div");
        div.className = "gitem";
        div.innerHTML = `
          <div class="gitem-top">
            <div class="gname">${game}</div>
            <div class="nums">
              <span>${PLAYER_A} <b class="mono">${w}</b></span>
              <span>${PLAYER_B} <b class="mono">${l}</b></span>
            </div>
          </div>

          <div class="rate" aria-label="å‹ç‡ï¼ˆã„ã¤ãï¼‰">
            <span class="bar"><i style="width:${clamp(itsukiRate,0,100)}%"></i></span>
            <span class="pct mono">${fmtPct(itsukiRate)}</span>
          </div>

          <div class="gactions">
            <button class="btn mini itsuki" data-act="itsuki" data-game="${game}">${PLAYER_A}å‹ã¡ï¼‹</button>
            <button class="btn mini yuzuki" data-act="yuzuki" data-game="${game}">${PLAYER_B}å‹ã¡ï¼‹</button>
            <button class="btn mini ghost" data-act="undo" data-game="${game}">æˆ»ã™</button>
          </div>
        `;
        glist.appendChild(div);
      }

      glist.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.dataset.act;
          const game = btn.dataset.game;
          if(act==="itsuki") quickAdd(game, "itsuki");
          if(act==="yuzuki") quickAdd(game, "yuzuki");
          if(act==="undo") undoOne(game);
        });
      });
    }

    function quickAdd(game, winner){
      if(winner==="itsuki") state.stats[game].win++;
      else state.stats[game].loss++;

      state.log.unshift({
        id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        ts: Date.now(),
        game,
        winner,
        note: ""
      });
      state.log = state.log.slice(0,100);

      saveState();
      renderAll();
    }

    function undoOne(game){
      const idx = state.log.findIndex(x => x.game === game);
      if(idx !== -1){
        const item = state.log[idx];
        if(item.winner==="itsuki" && state.stats[game].win>0) state.stats[game].win--;
        if(item.winner==="yuzuki" && state.stats[game].loss>0) state.stats[game].loss--;
        state.log.splice(idx,1);
      }else{
        if(state.stats[game].win>0) state.stats[game].win--;
        else if(state.stats[game].loss>0) state.stats[game].loss--;
      }
      saveState();
      renderAll();
    }

    function drawDonut(){
      const canvas = $("#donut");
      const ctx = canvas.getContext("2d");

      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);

      const W = rect.width, H = rect.height;
      ctx.clearRect(0,0,W,H);

      const { itsuki, yuzuki, w, l, t } = calcRates();

      const cx = W/2, cy = H/2;
      const r = Math.min(W,H) * 0.33;
      const ring = r * 0.42;

      ctx.lineWidth = ring;
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();

      if(t===0){
        ctx.fillStyle = "rgba(234,240,255,.95)";
        ctx.font = "900 16px Inter, sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("ã¾ã è¨˜éŒ²ãŒãªã„ã§", cx, cy-6);
        ctx.fillStyle = "rgba(154,166,195,.95)";
        ctx.font = "800 12px Inter, sans-serif";
        ctx.fillText("1è©¦åˆå…¥ã‚ŒãŸã‚‰æ¯”ç‡ãŒå‡ºã‚‹", cx, cy+14);
        return;
      }

      const start = -Math.PI/2;
      const itsukiAngle = (itsuki/100) * Math.PI * 2;

      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--itsuki").trim();
      ctx.beginPath(); ctx.arc(cx,cy,r,start,start+itsukiAngle); ctx.stroke();

      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--yuzuki").trim();
      ctx.beginPath(); ctx.arc(cx,cy,r,start+itsukiAngle,start+Math.PI*2); ctx.stroke();

      ctx.fillStyle = "rgba(234,240,255,.98)";
      ctx.font = "900 18px Inter, sans-serif";
      ctx.textAlign = "center";
      ctx.fillText(`${PLAYER_A} ${fmtPct(itsuki)} / ${PLAYER_B} ${fmtPct(yuzuki)}`, cx, cy-2);

      ctx.fillStyle = "rgba(154,166,195,.95)";
      ctx.font = "800 12px Inter, sans-serif";
      ctx.fillText(`${PLAYER_A} ${w} - ${PLAYER_B} ${l}ï¼ˆåˆè¨ˆ ${t}ï¼‰`, cx, cy+18);
    }

    function renderFilterOptions(){
      const sel = $("#filterGame");
      const current = sel.value || "all";
      sel.innerHTML = `<option value="all">ã™ã¹ã¦è¡¨ç¤º</option>` + GAMES.map(g=>`<option value="${g}">${g}</option>`).join("");
      sel.value = (current==="all" || GAMES.includes(current)) ? current : "all";
    }

    function renderLog(){
      const filter = $("#filterGame").value;
      const logEl = $("#log");

      const items = state.log
        .filter(x => filter==="all" ? true : x.game===filter)
        .slice(0, 30);

      if(items.length === 0){
        logEl.innerHTML = `<div class="help">ã¾ã ãƒ­ã‚°ãŒãªã„ã§ã€‚ã€Œï¼‹ 1è©¦åˆã‚’è¨˜éŒ²ã€ã‹ã€ç«¶æŠ€ã‚«ãƒ¼ãƒ‰ã®ãƒœã‚¿ãƒ³ã§è¿½åŠ ã—ã¦ã¿ã¦ã€‚</div>`;
        return;
      }

      logEl.innerHTML = items.map(x=>{
        const winner = x.winner==="itsuki" ? PLAYER_A : PLAYER_B;
        const loser  = x.winner==="itsuki" ? PLAYER_B : PLAYER_A;
        const note = (x.note||"").trim();
        return `
          <div class="log-item">
            <div class="left">
              <div class="meta">${niceDate(x.ts)} / ${x.game}</div>
              <div class="main">${winner}ã®å‹ã¡ï¼ˆ${winner} vs ${loser}ï¼‰${note ? "ï¼š" + escapeHtml(note) : ""}</div>
            </div>
            <span class="tag"><strong>${winner}</strong> WIN</span>
          </div>
        `;
      }).join("");
    }

    /* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¨˜éŒ²ï¼‰ ===== */
    function openModal(){
      $("#backdrop").style.display = "grid";
      $("#mNote").focus();
    }
    function closeModal(){
      $("#backdrop").style.display = "none";
      $("#mNote").value = "";
      $("#mWinner").value = "itsuki";
      $("#mGame").value = GAMES[0];
    }

    function bindModal(){
      $("#mGame").innerHTML = GAMES.map(g=>`<option value="${g}">${g}</option>`).join("");
      $("#mGame").value = GAMES[0];

      $("#openAdd").addEventListener("click", openModal);
      $("#closeAdd").addEventListener("click", closeModal);
      $("#cancelAdd").addEventListener("click", closeModal);

      $("#backdrop").addEventListener("click", (e)=>{
        if(e.target.id === "backdrop") closeModal();
      });

      $("#saveMatch").addEventListener("click", ()=>{
        const game = $("#mGame").value;
        const winner = $("#mWinner").value;
        const note = ($("#mNote").value || "").trim();

        if(winner === "itsuki") state.stats[game].win++;
        else state.stats[game].loss++;

        state.log.unshift({
          id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
          ts: Date.now(),
          game,
          winner,
          note
        });
        state.log = state.log.slice(0,100);

        saveState();
        closeModal();
        renderAll();
      });
    }

    /* ===== çµæœç™ºè¡¨ï¼ˆé›†è¨ˆï¼‹ç…½ã‚Šï¼‰ ===== */
    function openResult(){
      buildResultScreen();
      $("#resultBackdrop").style.display = "grid";
    }
    function closeResult(){
      $("#resultBackdrop").style.display = "none";
    }

    function buildResultScreen(){
      const { itsuki, yuzuki, w, l, t } = calcRates();

      // ç«¶æŠ€åˆ¥ã¾ã¨ã‚ï¼ˆè©¦åˆæ•°å¤šã„é †ï¼‰
      const rows = GAMES.map(g=>{
        const s = state.stats[g];
        return { game:g, iw:s.win, yz:s.loss, total:s.win+s.loss };
      }).filter(r=>r.total>0).sort((a,b)=>b.total-a.total);

      // ã‚¿ã‚¤ãƒˆãƒ«ï¼†ç…½ã‚Šï¼ˆè»½ã‚ï¼‰
      let title = "ã¾ã å‹è² ã—ã¦ã¸ã‚“ã‚„ã‚“ã€‚";
      let line  = "ã¨ã‚Šã‚ãˆãš1è©¦åˆã‚„ã£ã¦ã‹ã‚‰çµæœç™ºè¡¨ã—ã‚ˆã‹ã€‚";

      if(t>0){
        if(w === l){
          title = "å¼•ãåˆ†ã‘ï¼ã“ã‚Œã¯ã“ã‚Œã§ã‚¢ãƒ„ã„ã€‚";
          line  = `ã©ã£ã¡ã‚‚åŒã˜ã ã‘å‹ã£ã¦ã‚‹ã€‚æ¬¡ã®1å‹ã§ãƒã‚¦ãƒ³ãƒˆå–ã‚Œã‚‹ã§ã€‚`;
        } else {
          const winnerName = (w>l) ? PLAYER_A : PLAYER_B;
          const loserName  = (w>l) ? PLAYER_B : PLAYER_A;
          const diff = Math.abs(w-l);

          const taunts = [
            `ã€${loserName}ã€‘ä»Šæ—¥ã¯â€œä¼¸ã³ã—ã‚â€å¤šã‚ã‚„ãªï¼Ÿ`,
            `ã€${loserName}ã€‘è² ã‘æ•°ã‚‚æ‰èƒ½ã£ã¦ã“ã¨ã«ã—ã¨ã“ã‹ã€‚`,
            `ã€${loserName}ã€‘æ¬¡ã¯æœ¬æ°—å‡ºã™ã£ã¦ä½•å›è¨€ã†ã­ã‚“ï½—`,
            `ã€${loserName}ã€‘æ‚”ã—ã‹ã£ãŸã‚‰å‹ã£ã¦é»™ã‚‰ã›ã¦ã¿ï¼Ÿ`,
            `ã€${loserName}ã€‘é‹ã‚‚å®ŸåŠ›ã®ã†ã¡ã€ã£ã¦çŸ¥ã£ã¦ã‚‹ï¼Ÿ`
          ];
          const pick = taunts[(t + diff) % taunts.length];

          title = `å‹è€…ï¼š${winnerName} ğŸ‰`;
          line  = `${winnerName}ãŒ ${diff}å‹å·®ã§ãƒªãƒ¼ãƒ‰ä¸­ã€‚${pick}`;
        }
      }

      $("#resultTitle").textContent = title;
      $("#resultLine").textContent  = line;

      $("#rItsukiWins").textContent = w;
      $("#rYuzukiWins").textContent = l;
      $("#rRates").textContent = `${PLAYER_A} ${fmtPct(itsuki)} / ${PLAYER_B} ${fmtPct(yuzuki)}`;

      const table = $("#resultTable");
      // headä»¥å¤–ã‚’å‰Šé™¤
      table.querySelectorAll(".result-row:not(.head)").forEach(n=>n.remove());

      if(rows.length===0){
        const empty = document.createElement("div");
        empty.className = "result-row";
        empty.innerHTML = `<div class="game-name">â€”</div><div class="right">â€”</div><div class="right">â€”</div><div class="right">â€”</div>`;
        table.appendChild(empty);
      } else {
        for(const r of rows){
          const el = document.createElement("div");
          el.className = "result-row";
          el.innerHTML = `
            <div class="game-name">${r.game}</div>
            <div class="right mono">${r.iw}</div>
            <div class="right mono">${r.yz}</div>
            <div class="right mono">${r.total}</div>
          `;
          table.appendChild(el);
        }
      }
    }

    async function copyResult(){
      const { itsuki, yuzuki, w, l, t } = calcRates();
      const lines = [];
      lines.push(`ã€çµæœç™ºè¡¨ã€‘${PLAYER_A} vs ${PLAYER_B}`);
      lines.push(`åˆè¨ˆï¼š${w} - ${l}ï¼ˆ${t}è©¦åˆï¼‰`);
      lines.push(`å‹ç‡ï¼š${PLAYER_A} ${fmtPct(itsuki)} / ${PLAYER_B} ${fmtPct(yuzuki)}`);
      lines.push("");
      lines.push("ã€ç«¶æŠ€åˆ¥ã€‘");
      const rows = GAMES.map(g=>{
        const s = state.stats[g];
        const total = s.win+s.loss;
        return {g, w:s.win, l:s.loss, total};
      }).filter(x=>x.total>0).sort((a,b)=>b.total-a.total);

      if(rows.length===0) lines.push("ã¾ã è¨˜éŒ²ãªã—");
      else rows.forEach(r=>lines.push(`${r.g}ï¼š${PLAYER_A} ${r.w} - ${PLAYER_B} ${r.l}ï¼ˆ${r.total}ï¼‰`));

      const text = lines.join("\n");

      try{
        await navigator.clipboard.writeText(text);
        alert("çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã§ï¼");
      }catch{
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¤ã„ç’°å¢ƒç”¨ï¼‰
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        alert("çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã§ï¼");
      }
    }

    /* Controls */
    function bindControls(){
      $("#filterGame").addEventListener("change", renderLog);

      $("#clearLog").addEventListener("click", ()=>{
        const ok = confirm("ãƒ­ã‚°ã ã‘æ¶ˆã™ã§ï¼Ÿï¼ˆå‹æ•—ã®æ•°å­—ã¯æ®‹ã‚‹ï¼‰");
        if(!ok) return;
        state.log = [];
        saveState();
        renderAll();
      });

      $("#resetAll").addEventListener("click", ()=>{
        const ok = confirm("å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã™ã‚‹ã§ï¼Ÿï¼ˆå‹æ•—ãƒ»ãƒ­ã‚°å…¨éƒ¨æ¶ˆãˆã‚‹ï¼‰");
        if(!ok) return;
        state = defaultState();
        saveState();
        renderAll();
      });

      // çµæœç™ºè¡¨
      $("#openResult").addEventListener("click", openResult);
      $("#closeResult").addEventListener("click", closeResult);
      $("#resultBackdrop").addEventListener("click", (e)=>{
        if(e.target.id === "resultBackdrop") closeResult();
      });

      $("#resultCopy").addEventListener("click", copyResult);
      $("#resultReset").addEventListener("click", ()=>{
        const ok = confirm("ã“ã®ã¾ã¾å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã§ï¼Ÿï¼ˆå‹æ•—ãƒ»ãƒ­ã‚°å…¨éƒ¨æ¶ˆãˆã‚‹ï¼‰");
        if(!ok) return;
        state = defaultState();
        saveState();
        closeResult();
        renderAll();
      });
    }

    function renderAll(){
      renderHeader();
      renderSummary();
      renderGameList();
      renderFilterOptions();
      renderLog();
      drawDonut();
    }

    window.addEventListener("resize", drawDonut);

    /* Boot */
    $("#matchupLabel").textContent = `${PLAYER_A} VS ${PLAYER_B}`;
    bindModal();
    bindControls();
    renderAll();

    // è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹æ“ä½œ
    $("#backdrop").addEventListener("click", (e)=>{
      if(e.target.id === "backdrop") closeModal();
    });
    $("#resultBackdrop").addEventListener("click", (e)=>{
      if(e.target.id === "resultBackdrop") closeResult();
    });
  </script>
</body>
</html>

